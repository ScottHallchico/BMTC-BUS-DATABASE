<!DOCTYPE html>
<html>
<head>
    <title>BMTC Super Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { overflow-x: hidden; }
        #map { height: 500px; width: 100%; border-radius: 10px; border: 2px solid #ddd; }
        .sidebar { min-height: 100vh; background-color: #1a1d20; color: white; }
        .nav-link { color: rgba(255,255,255,0.7); margin-bottom: 2px; padding: 10px 15px; }
        .nav-link:hover, .nav-link.active { background-color: #0d6efd; color: white; }
        .nav-link i { margin-right: 10px; width: 20px; text-align: center; }
        .table-card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { border-bottom: 3px solid #0d6efd; display: inline-block; padding-bottom: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        
        <div class="col-md-2 sidebar p-3">
            <h4 class="mb-4 text-center"><i class="bi bi-bus-front"></i> BMTC System</h4>
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                
                <small class="text-muted text-uppercase fw-bold mt-2 mb-1" style="font-size: 11px;">Operations</small>
                <button class="nav-link active text-start" data-bs-toggle="pill" data-bs-target="#tab-map">
                    <i class="bi bi-geo-alt-fill"></i> Live Tracking
                </button>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#tab-assignments">
                    <i class="bi bi-clipboard-check"></i> Assignments
                </button>

                <small class="text-muted text-uppercase fw-bold mt-3 mb-1" style="font-size: 11px;">Resources</small>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#tab-buses">
                    <i class="bi bi-truck"></i> Buses
                </button>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#tab-drivers">
                    <i class="bi bi-person-badge"></i> Drivers
                </button>

                <small class="text-muted text-uppercase fw-bold mt-3 mb-1" style="font-size: 11px;">Network</small>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#tab-routes">
                    <i class="bi bi-map"></i> Routes
                </button>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#tab-stops">
                    <i class="bi bi-sign-stop"></i> Stops
                </button>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#tab-routestops">
                    <i class="bi bi-signpost-split"></i> Route Stops
                </button>
                <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#tab-trips">
                    <i class="bi bi-calendar-event"></i> Trips
                </button>

                <hr>
                <a href="/" class="nav-link text-start text-danger">
                    <i class="bi bi-box-arrow-left"></i> Logout
                </a>
            </div>
        </div>

        <div class="col-md-10 p-4 bg-light">
            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="tab-map">
                    <h2>üìç Live Tracking</h2>
                    <div id="map"></div>
                </div>

                <div class="tab-pane fade" id="tab-assignments">
                    <h2>üìã Trip Assignments</h2>
                    <div class="card table-card p-3">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Assignment ID</th> <th>Trip ID</th>
                                    <th>Route</th>
                                    <th>Bus Reg</th>
                                    <th>Driver</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for a in assignments %}
                                <tr>
                                    <td>{{ a.assignment_id }}</td> <td>{{ a.trip_id }}</td> <td>{{ a.route_code }}</td>
                                    <td>{{ a.reg_no }}</td> <td>{{ a.driver_name }}</td> <td>{{ a.assignment_time }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-buses">
                    <h2>üöå Bus Fleet</h2>
                    <div class="card table-card p-3">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Bus ID</th> <th>Reg No</th>
                                    <th>Capacity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for b in buses %}
                                <tr>
                                    <td>{{ b.bus_id }}</td> <td>{{ b.reg_no }}</td> <td>{{ b.capacity }}</td>
                                    <td><span class="badge bg-{{ 'success' if b.status == 'Active' else 'warning' }}">{{ b.status }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-drivers">
                    <h2>üë®‚Äç‚úàÔ∏è Driver Roster</h2>
                    <div class="card table-card p-3">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Driver ID</th> <th>Name</th>
                                    <th>Phone</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in drivers %}
                                <tr><td>{{ d.driver_id }}</td> <td>{{ d.name }}</td> <td>{{ d.phone }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-routes">
                    <h2>üõ£Ô∏è Routes</h2>
                    <div class="card table-card p-3">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Route ID</th> <th>Code</th>
                                    <th>Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in routes %}
                                <tr><td>{{ r.route_id }}</td> <td>{{ r.code }}</td> <td>{{ r.name }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-stops">
                    <h2>üõë Bus Stops</h2>
                    <div class="card table-card p-3">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Stop ID</th> <th>Name</th>
                                    <th>Lat</th>
                                    <th>Lng</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in stops %}
                                <tr><td>{{ s.stop_id }}</td> <td>{{ s.name }}</td> <td>{{ s.latitude }}</td> <td>{{ s.longitude }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-routestops">
                    <h2>üîó Route Sequences</h2>
                    <div class="card table-card p-3">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Route-Stop ID</th> <th>Route Code</th>
                                    <th>Stop Name</th>
                                    <th>Sequence</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rs in route_stops %}
                                <tr><td>{{ rs.route_stop_id }}</td> <td>{{ rs.route_code }}</td> <td>{{ rs.stop_name }}</td> <td>{{ rs.sequence_no }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-trips">
                    <h2>üìÖ Scheduled Trips</h2>
                    <div class="card table-card p-3">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Trip ID</th> <th>Route Code</th>
                                    <th>Date</th>
                                    <th>Start Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in trips %}
                                <tr>
                                    <td>{{ t.trip_id }}</td> <td>{{ t.route_code }}</td> <td>{{ t.scheduled_date }}</td>
                                    <td>{{ t.scheduled_start_time }}</td> <td>{{ t.status }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([12.9716, 77.5946], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var markers = {};
    function updateLocations() {
        fetch('/api/locations')
            .then(response => response.json())
            .then(data => {
                data.forEach(bus => {
                    if (markers[bus.bus_id]) {
                        markers[bus.bus_id].setLatLng([bus.lat, bus.lng]);
                        markers[bus.bus_id].bindPopup("<b>Bus ID: " + bus.bus_id + "</b><br>Speed: " + bus.speed + " km/h");
                    } else {
                        var marker = L.marker([bus.lat, bus.lng]).addTo(map)
                            .bindPopup("<b>Bus ID: " + bus.bus_id + "</b><br>Speed: " + bus.speed + " km/h");
                        markers[bus.bus_id] = marker;
                    }
                });
            });
    }
    setInterval(updateLocations, 1000);

    // Leaflet map resize fix when tab changes
    var mapTab = document.querySelector('[data-bs-target="#tab-map"]');
    mapTab.addEventListener('shown.bs.tab', function (event) {
        setTimeout(function() { map.invalidateSize(); }, 100);
    });
</script>

</body>
</html>