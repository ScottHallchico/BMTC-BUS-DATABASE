<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BMTC Super Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        body { overflow-x: hidden; }
        #map { height: 500px; width: 100%; border-radius: 10px; }
        .sidebar { min-height: 100vh; background: #1a1d20; color: white; }
        .nav-link { color: rgba(255,255,255,0.7); margin-bottom: 2px; }
        .nav-link.active, .nav-link:hover { background: #0d6efd; color: white; }
    </style>
</head>
<body>

<div class="container-fluid">
<div class="row">

<!-- ================= SIDEBAR ================= -->
<div class="col-md-2 sidebar p-3">
    <h4 class="text-center mb-4">
        <i class="bi bi-bus-front"></i> BMTC
    </h4>

    <div class="nav flex-column nav-pills">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-map">
            <i class="bi bi-geo-alt-fill"></i> Live Tracking
        </button>
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-assignments">
            <i class="bi bi-clipboard-check"></i> Assignments
        </button>
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-buses">
            <i class="bi bi-truck"></i> Buses
        </button>
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-drivers">
            <i class="bi bi-person-badge"></i> Drivers
        </button>
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-routes">
            <i class="bi bi-map"></i> Routes
        </button>
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-stops">
            <i class="bi bi-sign-stop"></i> Stops
        </button>
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-routestops">
            <i class="bi bi-signpost-split"></i> Route Stops
        </button>
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-trips">
            <i class="bi bi-calendar-event"></i> Trips
        </button>

        <hr>
        <a href="/" class="nav-link text-danger">
            <i class="bi bi-box-arrow-left"></i> Logout
        </a>
    </div>
</div>

<!-- ================= CONTENT ================= -->
<div class="col-md-10 p-4 bg-light">
<div class="tab-content">

<!-- ===== MAP ===== -->
<div class="tab-pane fade show active" id="tab-map">
    <h3>Live Tracking</h3>
    <div id="map"></div>
</div>

<!-- ===== ASSIGNMENTS ===== -->
<div class="tab-pane fade" id="tab-assignments">
    <h3>Trip Assignments</h3>
    <table class="table table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th><th>Trip</th><th>Route</th>
            <th>Bus</th><th>Driver</th><th>Time</th>
        </tr>
        </thead>
        <tbody>
        {% for a in assignments %}
        <tr>
            <td>{{ a.assignment_id }}</td>
            <td>{{ a.trip_id }}</td>
            <td>{{ a.route_code }}</td>
            <td>{{ a.reg_no }}</td>
            <td>{{ a.driver_name }}</td>
            <td>{{ a.assignment_time }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- ===== BUSES ===== -->
<div class="tab-pane fade" id="tab-buses">
    <h3>Buses</h3>

    <button class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#addBusModal">
        ➕ Add Bus
    </button>

    <table class="table table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th><th>Reg No</th><th>Capacity</th><th>Status</th><th></th>
        </tr>
        </thead>
        <tbody>
        {% for b in buses %}
        <tr>
            <td>{{ b.bus_id }}</td>
            <td>{{ b.reg_no }}</td>
            <td>{{ b.capacity }}</td>
            <td>{{ b.status }}</td>
            <td>
                <form method="POST"
                      action="/bus/delete/{{ b.bus_id }}"
                      onsubmit="return confirm('Delete bus?');">
                    <button class="btn btn-sm btn-danger">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- ===== DRIVERS ===== -->
<div class="tab-pane fade" id="tab-drivers">
    <h3>Drivers</h3>

    <button class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#addDriverModal">
        ➕ Add Driver
    </button>

    <table class="table table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th><th>Name</th><th>Phone</th><th></th>
        </tr>
        </thead>
        <tbody>
        {% for d in drivers %}
        <tr>
            <td>{{ d.driver_id }}</td>
            <td>{{ d.name }}</td>
            <td>{{ d.phone }}</td>
            <td>
                <form method="POST"
                      action="/driver/delete/{{ d.driver_id }}"
                      onsubmit="return confirm('Delete driver?');">
                    <button class="btn btn-sm btn-danger">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- ===== ROUTES ===== -->
<div class="tab-pane fade" id="tab-routes">
    <h3>Routes</h3>
    <table class="table table-striped">
        {% for r in routes %}
        <tr>
            <td>{{ r.route_id }}</td>
            <td>{{ r.code }}</td>
            <td>{{ r.name }}</td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- ===== STOPS ===== -->
<div class="tab-pane fade" id="tab-stops">
    <h3>Stops</h3>
    <table class="table table-striped">
        {% for s in stops %}
        <tr>
            <td>{{ s.stop_id }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.latitude }}</td>
            <td>{{ s.longitude }}</td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- ===== ROUTE STOPS ===== -->
<div class="tab-pane fade" id="tab-routestops">
    <h3>Route Stops</h3>
    <table class="table table-striped">
        {% for rs in route_stops %}
        <tr>
            <td>{{ rs.route_stop_id }}</td>
            <td>{{ rs.route_code }}</td>
            <td>{{ rs.stop_name }}</td>
            <td>{{ rs.sequence_no }}</td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- ===== TRIPS ===== -->
<div class="tab-pane fade" id="tab-trips">
    <h3>Trips</h3>
    <table class="table table-striped">
        {% for t in trips %}
        <tr>
            <td>{{ t.trip_id }}</td>
            <td>{{ t.route_code }}</td>
            <td>{{ t.scheduled_date }}</td>
            <td>{{ t.scheduled_start_time }}</td>
            <td>{{ t.status }}</td>
        </tr>
        {% endfor %}
    </table>
</div>

</div>
</div>
</div>
</div>

<!-- ================= MODALS ================= -->

<!-- ADD BUS -->
<div class="modal fade" id="addBusModal">
<div class="modal-dialog">
<form class="modal-content" method="POST" action="/bus/add">
<div class="modal-header"><h5>Add Bus</h5></div>
<div class="modal-body">
    <input name="reg_no" class="form-control mb-2" placeholder="Reg No" required>
    <input name="capacity" class="form-control mb-2" placeholder="Capacity">
    <select name="status" class="form-control">
        <option>Active</option>
        <option>Inactive</option>
    </select>
</div>
<div class="modal-footer">
    <button class="btn btn-success">Save</button>
</div>
</form>
</div>
</div>

<!-- ADD DRIVER -->
<div class="modal fade" id="addDriverModal">
<div class="modal-dialog">
<form class="modal-content" method="POST" action="/driver/add">
<div class="modal-header"><h5>Add Driver</h5></div>
<div class="modal-body">
    <input name="name" class="form-control mb-2" placeholder="Name" required>
    <input name="phone" class="form-control" placeholder="Phone">
</div>
<div class="modal-footer">
    <button class="btn btn-success">Save</button>
</div>
</form>
</div>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
var map = L.map('map').setView([12.9716, 77.5946], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let markers = {};
setInterval(() => {
    fetch('/api/locations')
        .then(res => res.json())
        .then(data => {
            data.forEach(b => {
                if (markers[b.bus_id]) {
                    markers[b.bus_id].setLatLng([b.lat, b.lng]);
                } else {
                    markers[b.bus_id] = L.marker([b.lat, b.lng]).addTo(map);
                }
            });
        });
}, 1000);
</script>

</body>
</html>
