<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        #map { height: 400px; width: 100%; border-radius: 10px; }
        .sidebar { min-height: 100vh; background-color: #212529; color: white; }
        .nav-link { color: rgba(255,255,255,0.8); margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background-color: #0d6efd; color: white; }
        .nav-link i { margin-right: 10px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        
        <div class="col-md-2 sidebar p-3">
            <h3 class="mb-4"><i class="bi bi-bus-front-fill"></i> BMTC Admin</h3>
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                <button class="nav-link active text-start" id="tab-map" data-bs-toggle="pill" data-bs-target="#content-map">
                    <i class="bi bi-speedometer2"></i> Live Tracking
                </button>
                <button class="nav-link text-start" id="tab-fleet" data-bs-toggle="pill" data-bs-target="#content-fleet">
                    <i class="bi bi-truck"></i> Fleet Database
                </button>
                <button class="nav-link text-start" id="tab-staff" data-bs-toggle="pill" data-bs-target="#content-staff">
                    <i class="bi bi-people-fill"></i> Staff Records
                </button>
                <button class="nav-link text-start" id="tab-schedule" data-bs-toggle="pill" data-bs-target="#content-schedule">
                    <i class="bi bi-calendar-week"></i> Bus Schedules
                </button>
                <hr>
                <a href="/" class="nav-link text-start text-danger">
                    <i class="bi bi-box-arrow-left"></i> Logout
                </a>
            </div>
        </div>

        <div class="col-md-10 p-4 bg-light">
            <div class="tab-content" id="v-pills-tabContent">
                
                <div class="tab-pane fade show active" id="content-map">
                    <h2>üìç Live Fleet Tracking</h2>
                    <div class="card p-3 shadow-sm">
                        <div id="map"></div>
                    </div>
                </div>

                <div class="tab-pane fade" id="content-fleet">
                    <h2>üöå Fleet Management</h2>
                    <div class="card p-3 shadow-sm">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Bus ID</th>
                                    <th>Registration No.</th>
                                    <th>Type</th>
                                    <th>Depot ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bus in fleet %}
                                <tr>
                                    <td>{{ bus.bus_id }}</td>
                                    <td>{{ bus.registration_number }}</td> <td>{{ bus.bus_type }}</td>            <td>{{ bus.depot_id }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="content-staff">
                    <h2>üë• Staff Directory</h2>
                    <div class="card p-3 shadow-sm">
                        <table class="table table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>ID</th>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>License No.</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for person in staff %}
                                <tr>
                                    <td>{{ person.staff_id }}</td>
                                    <td>{{ person.full_name }}</td>      <td>{{ person.role }}</td>           <td>{{ person.license_number }}</td> </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="content-schedule">
                    <h2>üìÖ Schedules</h2>
                    <div class="card p-3 shadow-sm">
                        {% if not schedules %}
                            <div class="alert alert-warning">No schedule data found.</div>
                        {% else %}
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Schedule ID</th>
                                        <th>Route ID</th>
                                        <th>Bus ID</th>
                                        <th>Departure</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for run in schedules %}
                                    <tr>
                                        <td>{{ run.schedule_id }}</td>
                                        <td>{{ run.route_id }}</td>
                                        <td>{{ run.bus_id }}</td>
                                        <td>{{ run.departure_time }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([12.9716, 77.5946], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var markers = {};
    function updateLocations() {
        fetch('/api/locations')
            .then(response => response.json())
            .then(data => {
                data.forEach(bus => {
                    if (markers[bus.bus_id]) {
                        markers[bus.bus_id].setLatLng([bus.lat, bus.lng]);
                    } else {
                        var marker = L.marker([bus.lat, bus.lng]).addTo(map)
                            .bindPopup("Bus ID: " + bus.bus_id);
                        markers[bus.bus_id] = marker;
                    }
                });
            });
    }
    setInterval(updateLocations, 1000);

    var mapTab = document.getElementById('tab-map')
    mapTab.addEventListener('shown.bs.tab', function (event) {
        setTimeout(function() { map.invalidateSize(); }, 100);
    })
</script>

</body>
</html>