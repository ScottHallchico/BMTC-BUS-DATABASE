<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMTC Live Tracking System</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; }
        
        /* Sidebar Styles */
        #sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 16px;
        }
        .stats { margin-top: 20px; padding: 10px; background: #34495e; border-radius: 5px; }

        /* Map Styles */
        #map { flex-grow: 1; height: 100%; }
        
        h2 { margin-top: 0; }
        small { color: #bdc3c7; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>BMTC Live ðŸšŒ</h2>
        <p>Select a route to track buses in real-time.</p>
        
        <label>Select Route:</label>
        <select id="routeSelect">
            <option value="">-- Loading Routes... --</option>
        </select>

        <div class="stats" id="infoBox">
            <h3>Status</h3>
            <p>Select a route to begin.</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Initialize Map (Centered on Bengaluru)
        const map = L.map('map').setView([12.9716, 77.5946], 12);

        // Add OpenStreetMap tiles
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Store bus markers here so we can update them later
        let busMarkers = {};
        let currentRouteId = null;

        // 2. Fetch Routes for Dropdown
        async function loadRoutes() {
            try {
                const response = await fetch('http://localhost:3000/api/routes');
                const routes = await response.json();
                
                const select = document.getElementById('routeSelect');
                select.innerHTML = '<option value="">-- Select a Route --</option>';
                
                routes.forEach(route => {
                    const option = document.createElement('option');
                    option.value = route.route_id;
                    option.text = `${route.route_number} (${route.start_point} - ${route.end_point})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("Error loading routes:", err);
            }
        }

        // 3. Main Function: Fetch Live Data & Move Markers
        async function updateBusLocations() {
            if (!currentRouteId) return;

            try {
                const response = await fetch(`http://localhost:3000/api/live-buses/${currentRouteId}`);
                const buses = await response.json();
                
                // Update Sidebar Info
                document.getElementById('infoBox').innerHTML = `
                    <h3>Route Active</h3>
                    <p>Tracking <strong>${buses.length}</strong> buses.</p>
                    <small>Last updated: ${new Date().toLocaleTimeString()}</small>
                `;

                // Loop through each bus
                buses.forEach(bus => {
                    if (!bus.live_data) return; // Skip if no GPS data yet

                    const { lat, lng, speed } = bus.live_data;
                    const busId = bus.bus_id;

                    // If marker exists, move it. If not, create it.
                    if (busMarkers[busId]) {
                        busMarkers[busId].setLatLng([lat, lng]);
                        busMarkers[busId].setPopupContent(`
                            <b>${bus.registration_number}</b><br>
                            Driver: ${bus.driver_name}<br>
                            Speed: ${speed} km/h
                        `);
                    } else {
                        // Create new marker with a Bus Icon
                        const marker = L.marker([lat, lng]).addTo(map)
                            .bindPopup(`
                                <b>${bus.registration_number}</b><br>
                                Driver: ${bus.driver_name}<br>
                                Speed: ${speed} km/h
                            `);
                        busMarkers[busId] = marker;
                    }
                });

            } catch (err) {
                console.error("Error fetching live data:", err);
            }
        }

        // Event Listeners
        document.getElementById('routeSelect').addEventListener('change', (e) => {
            currentRouteId = e.target.value;
            // Clear old markers when switching routes
            for (let id in busMarkers) {
                map.removeLayer(busMarkers[id]);
            }
            busMarkers = {};
            updateBusLocations(); // Fetch immediately
        });

        // Initialize
        loadRoutes();
        
        // Auto-refresh every 2 seconds
        setInterval(updateBusLocations, 2000);

    </script>
</body>
</html>